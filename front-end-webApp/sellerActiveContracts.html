<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title> View Active Contracts </title>
  <script type="text/javascript" src="https://npmcdn.com/parse/dist/parse.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
  <link href="background.css" rel="stylesheet" type="text/css">

      <meta name="robots" content="noindex, follow" />
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Favicon -->
  <!-- <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.png"> -->

  <!-- CSS
  ============================================ -->

  <!-- Bootstrap CSS -->

  <link rel="stylesheet" href="assets/css/vendor/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/vendor/font-awesome.css">
  <link rel="stylesheet" href="assets/css/vendor/flaticon/flaticon.css">
  <link rel="stylesheet" href="assets/css/vendor/slick.css">
  <link rel="stylesheet" href="assets/css/vendor/slick-theme.css">
  <link rel="stylesheet" href="assets/css/vendor/jquery-ui.min.css">
  <link rel="stylesheet" href="assets/css/vendor/sal.css">
  <link rel="stylesheet" href="assets/css/vendor/magnific-popup.css">
  <link rel="stylesheet" href="assets/css/vendor/base.css">
  <link rel="stylesheet" href="assets/css/style.min.css">
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    
    th, td {
      text-align: left;
      padding: 8px;
      border: 1px solid #ddd;
    }
    
    th {
      background-color: #8d9cf1;
    }
    h1{
      color:#fff
    }
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }

    .text-container {
      margin-top: 100px;
      opacity: 0;
      animation: fadeIn 1s forwards;
    }

    .text-line {
      font-size: 2em;
      margin-bottom: 20px;
    }

    select {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: #fff;
      color: #000;
      font-size: 1.5em;
      margin-top: 50px;
      cursor: pointer;
    }

    select:hover {
      background-color: #ccc;
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
      }
      100% {
        opacity: 1;
      }
    }

    @keyframes slideIn {
      0% {
        transform: translateY(50%);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
  </head>

  <body class="sticky-header">
    <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
<![endif]-->
    <a href="#top" class="back-to-top" id="backto-top"><i class="fal fa-arrow-up"></i></a>
    <!-- Start Header -->
    <header class="header axil-header header-style-5">
        
        <!-- Start Mainmenu Area  -->
        <div id="axil-sticky-placeholder"></div>
        <div class="axil-mainmenu">
            <div class="container">
                <div class="header-navbar">
                    <div class="header-brand">

                        <!-- will include our logo below when ready -->
                        <!-- <a href="index.html" class="logo logo-dark">
                            <img src="assets/images/logo/logo.png" alt="Site Logo">
                        </a>
                        <a href="index.html" class="logo logo-light">
                            <img src="assets/images/logo/logo-light.png" alt="Site Logo">
                        </a> -->


                    </div>
                    <div class="header-main-nav">
                        <!-- Start Mainmanu Nav -->
                        <!-- <nav class="mainmenu-nav">
                            <button class="mobile-close-btn mobile-nav-toggler"><i class="fas fa-times"></i></button>
                            <div class="mobile-nav-brand">
                                <a href="index.html" class="logo">
                                    <img src="assets/images/logo/logo.png" alt="Site Logo">
                                </a>
                            </div>
                            <ul class="mainmenu">
                            </ul>
                        </nav> -->
                        <!-- End Mainmanu Nav -->
                    </div>
                    <div class="header-action">
                        <ul class="action-list">
                            <li class="my-account">
                                <a href="javascript:void(0)">
                                    <i class="flaticon-person" style="color:rgb(244, 245, 242)"></i>
                                </a>
                                <div class="my-account-dropdown">
                                    <span class="title">QUICKLINKS</span>
                                    <ul>
                                        <!-- <li>
                                            <a href="my-account.html">My Account</a>
                                        </li> -->
                                        <li>
                                            <a href="homePage.html">Home Page</a>
                                        </li>
                                        <li>
                                          <a href="marketplace.html">Shop the Marketplace</a>
                                        </li>
                                        <li>
                                            <a href="buyerActiveContracts.html">My Active Contracts as Buyer</a>
                                        </li>
                                        <li>
                                            <a href="sellerDeployNewContract.html">List New Item for Sale</a>
                                        </li>
                                    </ul>
                                </div>
                            </li>
                            <li class="axil-mobile-toggle">
                                <button class="menu-btn mobile-nav-toggler">
                                    <i class="flaticon-menu-2"></i>
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Mainmenu Area -->
    </header>

  <body onload="connectMetamask()">



    <div class="container">
      <div class="text-container">
        <div class="text-line" id="time"></div>
        <div class="text-line" id="connectMetamask"></div>
        <div class="text-line" id="activeContracts"></div>
        
      </div>
      <select id="info-selector" onchange="selectInfo()">
        <option value="0" selected>Select Information</option>
      </select>
      <br>
      <br>
      <div class="text-line" id="chooseActiveContracts">Choose contract to view more details</div>
    </div>

    <body>

      
      <center><h1>Previous Terminated Contracts</h1></center>
      <!-- <div style="display: flex; justify-content: flex-center;">
        <form style="display: flex; align-items: center;"> -->
          <!-- <label for="search-input" style="font-size: 14px; margin-right: 5px;">Search by Item Name:</label>
          <div style="display: flex; align-items: center;"> -->
            <!-- <input type="text" id="search-input" name="search" placeholder="Enter item name" style="font-size: 14px; padding: 5px; width: 150px;">
            <button type="button" onclick="searchTransactions()" style="font-size: 14px; padding: 5px; height: 30px; width: 50px; border-radius: 5px;">Search</button> -->
            <!-- <input id ='inn' type="text" placeholder="Search by any key words...">
            <button id="submit">Search</button> -->
          <!-- </div>
        </form> -->
      </div>
      
      <div id="transaction-list">
      </div>
<!-- <div style="display: flex; justify-content: flex-end;">
  <form style="display: flex; align-items: center;">
    <label for="search-input" style="font-size: 14px; margin-right: 5px;">Search by Contract Address or item:</label>
    <div style="display: flex; align-items: center;">
      <input type="text" id="search-input" name="search" placeholder="Enter contract address or item name" style="font-size: 14px; padding: 5px; width: 150px;">
      <button type="button" onclick="searchTransactions()" style="font-size: 14px; padding: 5px; height: 30px; width: 50px; border-radius: 5px;">Search</button>
    </div>
  </form>
</div>

      <table id="transaction-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Item Name</th>
            <th>Contract Address</th>
            <th>Item Price</th>
            <th>Quantity</th>
            
          </tr>
        </thead>
        <tbody></tbody>
      </table> -->
    </body>



    <script>

        Parse.initialize("rgzBD2oDrFGwnP4GhepGqvLTb4zxUCVA8ISU94G6", "rbN8I2nlk462haH28HHxwAka3o02oVqWWz1PrFdi"); //PASTE HERE YOUR Back4App APPLICATION ID AND YOUR JavaScript KEY
        Parse.serverURL = "https://parseapi.back4app.com/";

        /* function that helps dynamically output text */
        async function outputText(id, text, speed) {
            var index = 0;
            var speed = speed;
            var container = document.getElementById(id);

            var interval = setInterval(function() {
            if (index < text.length) {
                container.innerHTML += text.charAt(index);
                index++;
            } else {
                clearInterval(interval);
            }
            }, speed);
        }

        printTime();



        const API_URL = "https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd";

        async function fetchETHPrice() {

            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                const ethPrice = data.ethereum.usd;
                console.log("Price of 1 ETH in USD:", ethPrice);
                return ethPrice;
            } catch (error) {
                console.error("Error fetching ETH price:", error);
            }
       }


        async function convertWeiToUSD(wei,  ethPrice) {
 
            const weiToEth = wei / 10**18;
            const weiToUSD = weiToEth * ethPrice;
            console.log(`${wei} Wei is worth ${weiToUSD} USD`);
            return weiToUSD;
        }

        async function convertUSDToWei(usd, ethPrice) {
            const usdToEth = usd / ethPrice;
           // const usdToWei = usdToEth * 10**18;
            console.log(`${usd} USD is worth ${usdToEth} Wei`);
            return usdToWei;
        }



        // connect to metamask when loading the page 

        let sellerAccount;
        const connectMetamask = async () => {
            if (window.ethereum !== "undefined") {
                const accounts = await ethereum.request({ method: "eth_requestAccounts" });
                sellerAccount = accounts[0];

                await readFromDB();
                
            }
            
        }

        function printTime() {
            var date = new Date();

            var month = date.toLocaleString('default', { month: 'long' });
            var day = date.getDate();
            var year = date.getFullYear();
            var time = date.toISOString().substr(11, 8);

            var dateString = month + " " + day + ", " + year + ", " + time + " UTC";
            
            outputText("time", dateString, 50);
        }


        const API_URL2 = "https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd";
        async function fetchETHPrice() {
        try {
          const response = await fetch(API_URL2);
          const data = await response.json();
          const ethPrice = data.ethereum.usd;
          console.log("Price of 1 ETH in USD:", ethPrice);
          return ethPrice;
        } catch (error) {
          console.error("Error fetching ETH price:", error);
        }
      }


async function readFromDB3(sellerAccount) {

const Transaction = Parse.Object.extend("Product_details");
const query = new Parse.Query(Transaction);
query.equalTo("SellerAddress", sellerAccount);
query.equalTo("contractStatus", "terminated");
query.descending("createdAt");

const ethPrice = await fetchETHPrice();

const transactions = await query.find();

const transactionList = document.getElementById("transaction-list");
transactions.forEach(async (transaction) => {

  const transactionDiv = document.createElement("div");
  transactionDiv.style.border = "1px solid white";
  transactionDiv.style.borderRadius = "5px";
  transactionDiv.style.padding = "15px";
  //transactionDiv.style.marginBottom = "10px";
  transactionDiv.style.margin = "15px";
  transactionDiv.style.display = "flex"; // enable flexbox layout


  const transactionDetailsStyle = `
    display: flex;
    justify-content: space-between;
    height: 100%;
  `;

  const imageDiv = document.createElement("div");
  imageDiv.style.width = "100px"; // set width for image container
  imageDiv.style.height = "100px";
  imageDiv.style.margin = "5px"; // add some space between image and details
  imageDiv.style.marginRight = "10px"; // add some space between image and details
  imageDiv.style.display = "flex";
  //imageDiv.style.flexGrow = 1; // make imageDiv take up all available space


  const date = transaction.get("createdAt").toDateString();
  const item = transaction.get("ProductName");
  const details = transaction.get("ProductDetails");
  const amount = transaction.get("ProductPrice");
  const ca = transaction.get("contractAddress");
  
  // const query3 = new Parse.Query("Product_details");
  // query3.equalTo("contractAddress", description);
  // const results = await query3.find();
  // const results2 = await query3.find();
  // const images = results.map(result => result.get("image").url());
  // const dd = results2.map(result => result.get("SellerAddress"));

  const image = document.createElement("img");
  image.src = transaction.get("image").url();
  image.style.width = "100%";
  image.style.height = "100%";
  image.style.objectFit = "fit"; // resize image to fill container without distorting
  

  imageDiv.appendChild(image);
  transactionDiv.appendChild(imageDiv);

  const detailsDiv = document.createElement("div");
  detailsDiv.style.display = "flex";
  detailsDiv.style.flexDirection = "column"; // stack details vertically
  detailsDiv.style.height = "100%";
  //detailsDiv.style.flexShrink = 1; 

  var wei = amount;
  var eth = wei / 10**18; // Convert Wei to ETH
  var usd = eth * ethPrice;

  detailsDiv.innerHTML = `
    <div style="${transactionDetailsStyle}"><span>Item Name: ${item}</span></div>
    <div style="${transactionDetailsStyle}"><span>Item Price: ${eth.toFixed(6)} ETH ($${usd.toFixed(2)})</span></div>
    <div style="${transactionDetailsStyle}"><span>Item Details: ${details}</span></div>
    <div style="${transactionDetailsStyle}"><span>Date Listed: ${date}</span></div>
    <div style="${transactionDetailsStyle}"><span>Contract Address: ${ca}</span></div>
  `;

  detailsDiv.querySelectorAll('div[style^="display: flex"]').forEach(div => {
    div.children[0].style.flexBasis = "50%";
    div.children[1].style.textAlign = "right";
  });

  transactionDiv.appendChild(imageDiv);
  transactionDiv.appendChild(detailsDiv);
  transactionList.appendChild(transactionDiv);
});
}


        async function readFromDB() {


          let contracts = [];
          let products = [];
          let prices = [];
            // fetch seller's active contracts' data from database
            var query = new Parse.Query("Product_details");

            // fetch rows that has column sellerAddress equal to seller Account
            query.equalTo("SellerAddress", sellerAccount);

            //const getBuyerState = await window.contract.methods.getTerminated().call();
            
            // Fetch the data from the parse class
            query.find().then(async function(results) {
                // Extract the data from the results and store it in an array
                results.forEach(obj => {
                  if (obj.get("contractStatus") != "terminated")
                  {
                  contracts.push(obj.get("contractAddress"));
                  products.push(obj.get("ProductName"));
                  prices.push(obj.get("ProductPrice"));
            }});
                
                var text = `Dear Seller: ${sellerAccount}, as of now, our system indicates that you have ${contracts.length} active 
                contract(s).`;

                outputText("connectMetamask", text, 30);

                // add all the contract address to the option bar
                var select = document.getElementById("info-selector"); // Get the select element

                const ethPrice = await fetchETHPrice();
                
                for (let i = 0; i < contracts.length; i++) { 

                  var eth = prices[i] / 10**18;; // Convert Wei to ETH
                  var usd = eth * ethPrice;
                  console.log(usd);

                  // wei / 1000000000000000000;


                    const info = `${products[i]} ($${usd.toFixed(2)}) - ${contracts[i]}`;
                    var option = document.createElement("option");
                    option.textContent = info; // Set the text content of the new option
                    option.value = contracts[i];
                    select.appendChild(option); // Add the new option to the select element
                }

                }, function(error) {
                console.log("Error: " + error.code + " " + error.message);
            });

            await readFromDB3(sellerAccount);
            
        }


        var select = document.getElementById("info-selector");
            select.addEventListener("change", function() {
                var selectedOption = select.options[select.selectedIndex];
                var contract = selectedOption.value;

                // store the contract address and seller address for next html page to access
                localStorage.setItem('contractAddress', contract);
                localStorage.setItem('sellerAddress', sellerAccount);

                window.location.href = "sellerContractPage.html";
        });


    </script>

    <script src="assets/js/vendor/modernizr.min.js"></script>
    <!-- jQuery JS -->
    <script src="assets/js/vendor/jquery.js"></script>
    <!-- Bootstrap JS -->
    <script src="assets/js/vendor/popper.min.js"></script>
    <script src="assets/js/vendor/bootstrap.min.js"></script>
    <script src="assets/js/vendor/slick.min.js"></script>
    <script src="assets/js/vendor/js.cookie.js"></script>
    <script src="assets/js/vendor/jquery-ui.min.js"></script>
    <script src="assets/js/vendor/jquery.countdown.min.js"></script>
    <script src="assets/js/vendor/sal.js"></script>
    <script src="assets/js/vendor/jquery.magnific-popup.min.js"></script>
    <script src="assets/js/vendor/imagesloaded.pkgd.min.js"></script>
    <script src="assets/js/vendor/isotope.pkgd.min.js"></script>
    <script src="assets/js/vendor/counterup.js"></script>
    <script src="assets/js/vendor/waypoints.min.js"></script>

    <!-- Main JS -->
    <script src="assets/js/main.js"></script>

  </body>
</html>
